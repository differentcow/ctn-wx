<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
        <meta name="description" content="">
        <!-- <link rel="shortcut icon" href="#" type="image/png"> -->
        <title>温度</title>
        <!-- 新 Bootstrap 核心 CSS 文件 -->
        <link rel="stylesheet" href="../css/bootstrap.min.css">
        <!--end copy-->
	</head>
	<body>
    <div class="container-fluid">
        <div style="height: 150px;">
            <input type="hidden" id="mark_touch" value="N" />
            <input type="hidden" id="mark_xy" />
            <input type="hidden" id="mark_xy_x" />
            <input type="hidden" id="mark_xy_y" />
            <input type="hidden" id="mark_xy_id" />
            <input type="hidden" id="mark_xy_color" />
        </div>
        <div class="row">
            <div class="col-sm-offset-2 col-lg-offset-2 col-md-offset-2 col-md-3 col-lg-3 col-sm-3">
                <table class="table">
                    <thead>
                    <tr>
                        <td>编号</td>
                        <td align="center">颜色</td>
                        <td>颜色值</td>
                        <td>定点</td>
                    </tr>
                    </thead>
                    <tbody data-bind="foreach:list">
                    <tr>
                        <td data-bind="text:$data.temp_code"></td>
                        <td align="center"><div data-bind="style:{backgroundColor:$data.color},attr:{id:$data.id}" style="height:20px;width:20px;border-radius:5px;">&nbsp;</div></td>
                        <td><input data-bind="event:{blur:function(){$root.changeColor($data.id,$data.color);}},value:$data.color"/></td>
                        <td><a tag="position" href="#" data-bind="click:function(){$root.setPosition($data.id,$element);}">定点</a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6 col-lg-6 col-sm-6">
                <div>
                    <iframe id="map_iframe" name="map_iframe" scrolling="no" data-bind="attr:{src:mapPath}" style="width: 635px;height: 355px;border: 1px solid #000000;"></iframe>
                </div>
            </div>
        </div>
    </div>
	</body>
    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/knockout-3.1.0.js"></script>
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="../js/bootstrap.min.js"></script>
    <script type="text/javascript">
        function TemperatureModel() {
            var me = this;
            this.list = ko.observableArray([]);
            this.mapPath = ko.observable('');
            this.init = function(){
               me.mapPath('map.html');
               me.getList();
            };
            this.updateXY = function(x,y,id){
                $.when($.ajax({
                    url: "/wx/service/temperature/xy/upt.json",
                    type: "PUT",
                    data:JSON.stringify({x:x,y:y,id:id}),
                    contentType : 'application/json'
                })).done(function(data){
                    if(data.state == 1){
                        $('a[tag=position]').each(function(){
                            $(this).text('定点')
                        });
                        $('#mark_xy').val('');
                        $('#mark_xy_id').val('');
                        $('#mark_xy_color').val('');
                        $('#mark_xy_x').val('');
                        $('#mark_xy_y').val('');
                    }
                }).fail(function(error){
                    console.log(error);
                });
            };
            this.setPosition = function(id,_this){
                var mark = $('#mark_xy').val();
                if(mark == 'Y'){
                    var x = $('#mark_xy_x').val();
                    var y = $('#mark_xy_y').val();
                    me.updateXY(x,y,id);
                }else{
                    $('a[tag=position]').each(function(){
                        $(this).text('')
                    });
                    $(_this).text('确定');
                    $('#mark_xy').val('Y');
                    $('#mark_xy_id').val(id);
                    $('#mark_xy_color').val( $('#'+id).css('background-color'));
                }
            };
            this.changeColor = function(id,color){
                var url = "/wx/service/temperature/color/upt.json";
                var param = {color:color,id:id};
                $.when($.ajax({
                    url: url,
                    type: "PUT",
                    data:JSON.stringify(param),
                    contentType : 'application/json'
                })).done(function(data){
                    if(data.state == 1){
                        $('#'+id).css('background-color',color);
                    }
                }).fail(function(error){
                    console.log(error);
                });
            };
            this.getList = function(){
                $.when($.getJSON("/wx/service/temperature/list.json?t="+Math.random())).done(function(data){
                    if(data.state == 1){
                        me.list([]);
                        me.list(data.array);
                    }
                }).fail(function(error){
                    console.log(error);
                });
            };
        };
        var model = new TemperatureModel();
        model.init();
        ko.applyBindings(model);
    </script>
</html>