<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
        <meta name="description" content="">
        <!-- <link rel="shortcut icon" href="#" type="image/png"> -->
        <title>温度</title>
        <style type="text/css">
            .contain-temp {
                -webkit-box-flex: 1;width: 100%;
            }
            .contain-temp-div {
                -webkit-box-flex: 1;width: 100%;
            }
        </style>
        <script type="text/javascript" src="../js/jquery-1.11.1.min.js"></script>
	</head>
	<body>
    <div class="contain-temp">
        <div class="contain-temp">
            <input type="date" id="from" />&nbsp;&nbsp;<input type="date" id="to" />&nbsp;&nbsp;<button id="store" >载入</button>
        </div>
        <div id="main" style="min-width: 310px; height: 400px; margin: 0 auto;" class="contain-temp"></div>
        <!--<div id="main2" style="height:400px"></div>-->
        <div class="contain-temp">
            <a href="temp.html">返回</a>
        </div>
        <script src="../js/echarts-s.js"></script>
        <script type="text/javascript">
            var x_ary = [];
            // Step:3 conifg ECharts's path, link to echarts.js from current page.
            // Step:3 为模块加载器配置echarts的路径，从当前页面链接到echarts.js，定义所需图表路径
            var one_day = 1000 * 60 * 60 * 24;
            Date.prototype.format = function (format) {
                var o = {
                    "M+": this.getMonth() + 1,
                    "d+": this.getDate(),
                    "h+": this.getHours(),
                    "m+": this.getMinutes(),
                    "s+": this.getSeconds(),
                    "q+": Math.floor((this.getMonth() + 3) / 3),
                    "S": this.getMilliseconds()
                }
                if (/(y+)/.test(format)) {
                    format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
                }
                for (var k in o) {
                    if (new RegExp("(" + k + ")").test(format)) {
                        format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
                    }
                }
                return format;
            };

            function getFormatDate(date, pattern) {
                if (date == undefined) {
                    date = new Date();
                }
                if (pattern == undefined) {
                    pattern = "yyyy-MM-dd hh:mm:ss";
                }
                return date.format(pattern);
            }
            function getTodayLongTime(){
                var d = new Date();
                var str = getFormatDate(d,"yyyy/MM/dd");
                var date = new Date(str).getTime();
                return date;
            }
            require.config({
                paths: {
                    echarts: '../js'
                }
            });

            // Step:4 require echarts and use it in the callback.
            // Step:4 动态加载echarts然后在回调函数中开始使用，注意保持按需加载结构定义图表路径
            require(['echarts','echarts/chart/bar','echarts/chart/line','echarts/chart/config'],function (ec) {
                        var TempModel = function(){
                            var me = this;
                            this.chart = null;
                            this.xdata = [];
                            this.ydata = [];
                            this.storeDataByTime = function(data,cnt){
                                if(cnt < data.length){
                                    me.chart.addData(0,data[cnt],false,true);
                                    cnt++;
                                    setTimeout(function(){me.storeDataByTime(data,cnt);},500);
                                }
                            };
                            this.loadData = function(){
                                var from = $('#from').val();
                                var to = $('#to').val();
                                var fd = new Date(from.replace(/-/g,"/")).getTime();
                                var td = new Date(to.replace(/-/g,"/")).getTime();
                                $.when($.getJSON("/wx/service/echart/day.json?from="+fd+"&to="+ td+"&t="+Math.random())).done(function(data){
                                    if(data.state == 1){
                                        me.ydata = [];
                                        var dd = me.option.xAxis[0].data;
                                        for(var i = 0; i < data.ary.length;i++){
                                            dd.splice(i,1,getFormatDate(new Date(data.ary[i].x),"MM/dd"));
                                            me.ydata.push(data.ary[i].y);
                                        }
                                        var tt = me.option.series[0].data;
                                        tt.splice(0,1,me.ydata[0]);
                                        me.chart.setOption(me.option,true);
                                        me.storeDataByTime(me.ydata,1);
                                    }
                                }).fail(function(error){
                                    console.log(error);
                                });
                            };
                            this.getData = function(){
                                var t = getTodayLongTime();
                                var to = t-one_day;
                                var from = t - one_day * 10;
                                $.when($.getJSON("/wx/service/echart/day.json?from="+from+'&to='+to+'&t='+Math.random()).done(function(data){
                                    if(data.state == 1){
                                        for(var i = 0; i < data.ary.length;i++){
                                            me.xdata.push(getFormatDate(new Date(data.ary[i].x),"MM/dd"));
                                            me.ydata.push(data.ary[i].y);
                                        }
                                        me.render();
                                        var dd = me.option.series[0].data;
                                        dd.splice(0,1,me.ydata[0]);

                                        me.chart.setOption(me.option);
                                        me.storeDataByTime(me.ydata,1);
                                    }
                                }).fail(function(error){
                                    console.log(error);
                                }));
                            };
                            this.render = function(){
                                //--- 折柱 ---
                                me.chart = ec.init(document.getElementById('main'));
                                me.chart.setOption(me.option);
                            };
                            this.init = function(){

                            };
                            this.option = {
                                title : {
                                    text: '温度统计(°C)'
//                                subtext: 'T1温度计实时数据与存储数据'
                                },
                                tooltip : {
                                    trigger: 'axis'
                                },
                                legend: {
                                    data:['温度数据']
                                },
                                toolbox: {
                                    show : true,
                                    feature : {
                                        magicType : {show: true, type: ['line', 'bar']},
                                        saveAsImage : {show: true}
                                    }
                                },
                                calculable : true,
                                xAxis : [
                                    {
                                        type : 'category',
                                        boundaryGap : true,
                                        splitArea : {show:false},
                                        splitLine : {show:false},
                                        data:me.xdata
                                    }
                                ],
                                yAxis : [
                                    {
                                        type : 'value',
                                        scale: true,
                                        splitArea : {show:false},
                                        splitLine : {show:false},
                                        name : '温度(°C)',
                                        boundaryGap: [0.2, 0.2],
                                        axisLabel:{
                                            formatter : function(val){
                                                return val + '°C';
                                            }
                                        }
                                    }
                                ],
                                series : [
                                    {
                                        name:'温度数据',
                                        type:'line',
                                        data:[0]
                                    }
                                ]
                            };
                        }
                        var temp = new TempModel();
                        temp.init();
                        $(document).ready(function(){
                            temp.getData();
                            $('#store').click(function(){
                                temp.loadData();
                            });
                        });

                    }
            );






        </script>
    </div>
	</body>
</html>